// (C) 2013 Prevoow UG & Co. KG, Edward Ackroyd, Paderborn, Germany 

if(!com) var com={};
if(!com.googlepreview) com.googlepreview={};
if(!com.googlepreview.package) com.googlepreview.package={};

com.googlepreview.package = {
GP_VERSION: 330,
GP_BEST_IMAGE_SERVER: "",
MAX_IMAGES_PER_PAGE: 25,
GP_DOCUMENT: null,
GPI_PREVIEW_WARN: "data:image/gif,GIF89ao%00R%00%E6%00%00%F4%0B%0B%F0%F3%F1fff%C4_Z%CC33%C4%B0%AC%AA%24%24%C3%A5%A0%C9%3E%3A%D8%D5%D3%FF_%5E%FF%24%24%FF%3A%3A%CC%CC%CC%DE()%FF%8B%8B%FF%A5%A3%FFRR%DF%24%24%BE%86%80%C8TR%FF33%EA%EC%E9%FA%8D%8B%FF%BC%BB%FFff%D6%8C%8B%F1%A9%A8%EF()%FE%F6%F5%F3PN%F1%DC%DA%FFII%E4%C7%C4%FF%99%99%C0sr%D5IF%F0%2F.%FF))%CBzy%FF%E6%E4%FF%7C%7C%FF%AC%AB%E1%BB%B9%FF%CC%CC%EF%3B%3A%E8%8F%8D%FF%5C%5B%E5%2F-%FFB%3A%CCff%DF%81%80%FA%24%24%CC%99%99%F6)*%F5%F3%F1%E4%D2%CF%F8%CC%CA%E8()%C7EC%F4%B5%B2%FF%DE%DB%FFts%EF%F2%F0%CC%87%85%F9%F2%F1%FF%93%91%C5%80%7B%CF%B0%AD%C3XW%C2rq%FF%FF%FF%EC%93%92%F8%FB%F9%FA%92%90%CF%40%3F%B3%24%24%FF%B4%B3%FF%AA%A7%CCff%DF%DB%D9%EB%E9%E6%CC%99%99%C6%88%85%FFff%FF%A1%9F%FF%5E_%FFAA%EF%F7%F7%FF%80%7F%FF%ED%EC%C5%B5%AD%D0%3E%3B%D3%D1%CE%E7%24%24%F2%C8%C6%BFzu%F8..%D2on%F4%F7%F5%CE%8C%84%FF%99%99%CF%B3%AE%F7%94%94%CEJB%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00!%F9%04%04%14%00%FF%00%2C%00%00%00%00o%00R%00%00%07%FF%80G%82%83%84%85%86%87%88%89%8A%8B%8C%8D%8E%8F%90%91%92%93%94%95%96%97%98%99%9A%9B%9C%9D%9E%9F%A0%A1%8C%3D%18N%22%A7%109%A2%AB%A0%2C%10%0F)%19%19%0AV%B5V%22%9F%00%00%AC%9CZ*%0F%19%11W%0C%C4%C4W%20%C8%AA%8A%BA%85%BB%89%CC%BC%99(U%3E%11%0C%15%D8a%DA%D8%15%C4a%3C%CB%D0G%E2%87%E4%D1%94Z%22%3E%20%D8%26%26%DC%15%EE%F0%26_%CF%BA%BB%F7%83%F7%CE%E3%CE%CC%FF%FC%F6%E9%C3G%D0%DC%26j%EC*%2CP%10a%01%B6%85%0D%E11%E8%80%A8%60%3FC%D02%12%BC%D8%CC%DF%3E%8D%9EX%A4%88%F00%83%20%10%0B%16%9Et%D8%CEEEA%1E%07%E6%E3%08%90c%BF%99%E2%3E%F2%DB%F4%40%C15%13%3E%08%81P%40%E8%85%3Bw-%82%94%EB%083%26%CD%8D%20%9F%0E%0C%85b%DD%C3%26%8A%90%B0%AC%60c%C5RBQ%A3JmJ%D6f%CEN%18%14%5C%E1f%02%EB%A1%1AL%FF%B4i%B3%A1%E1%EB%D4%A68%03%3A%C5%2B%F6%E6NMU%AC%B1%A5%01%C1%10%10%03%3A%E0%D9%10s%AE1%22!%20%AEq%5B%10%B4P%11%2F%F0%B8%CAp%CC%99%90%10%C9%0F%B3%20%CA%B0%B5%02%07%C6%9D%3B%3B%99%F7%40%91%8F%A3%26t%00%89f%F0Q%EDH%3D%DE%3D%ACB%C8H%DDA3hds%40%24u%A4%DB%91%40%C0%5E%80%EB%C8%08%26%12%94%08%02%13W%1B%87%25P%CAA%DD)%F0%22%C0%BC%7C%B9w%BF%7Bi%83%EE%87JNT_pA%BD%DC0%12%A6%24%D1%EE%FD%2F%D9%8FR%C3%3A5%87%3C%92%87%F3%0AI%10%C6d%02%CA%A5%C3%0E%09T%B4%1DX%02%91%03%92~e%F1g%1F%25%1F%94%00%60f%99q%40%40%01%F6%D4wWM%1Fn4V_6a%12%02%0C6%0C%88!7a%E8%40%C0%01%01%84SV%84%22%D28%E2~%13r%82%03%09%3A%A4%A8b%05rq%20%C1%0E%05%FC%B0%08%89%F89%18%13%FF%84%E11%C5%C9%0D5p%E1%80%0E%1CTY%A5%03%08L%D0%C5%7C%C61%D2%1F'Q%981%C4%00%14P0%00%18%07t%11c%97%E1%7C%F9I%00%16%C49%06%9Bt%D6i%E7%9Dx%E6%A9%E7%9E%7C%F6%E9%E7%9F%80%06*%E8%A0%84%16j%E8%A1%96%08%20%00%A2%A0(%EA%A8%A3G(j%88%A4%91PJ)%A3%97F%BAh'%99%1E%9A%E9%A3%9Bj%3A%C8%A3%93B*)%A8%82%90Z%08%AA%90%8E%DA%AA%A5%A1r%1A%2B%AC%A9n%DA%A9%AB%84%D0Z%EB%AE%B9%DA%EAk%A9%A2%06%EB%C9%A7%BF%06%ABj%AF%BA%5E%0Aj%AC%C6%16%AB%E9%AB%AD~B%2C%AF%CAF%EB%EA%A9%CE%DE%8Ak%B3%D4%FA%AA%AD%26%D3r%DB%2B%22%D8%F2*%2C%B3%C9%16%5B%AD(%E1%A6%7B%AB%AA%D5z%CB%AC%B8%F1%AE%CBh4%DF%DE%2B%ED%BC%AB%E4%AB%AF%AC%FF%F2%E2o%C0%E0%1Ek%F0%A2%CB%22%AC%AD%BB%EA%FE%3A%B0%C0%CEv%8B%AA%B8%E3%8AJ%2B%94%C3%FC%3A%86%B1%B9%E9%1E%02%AF%C3%0D%DFyq%C8%DD%9A%8Bl%C8%1D%DB9r%C9%2C%7Fko%B9%14%D3%B9%F1%B9%24%03%7Bm%A8%13%3FL%B0%C9%3B%0F%9Bq%CF%40%17%AAs%D0%92%0C%BD%E7%C7%F5*%8C%F3%C7%BB%E6%0C%AD%B0*%CFJr%CA0%EB%CA%ED%C4%22K%DD%F2%D4%0A%B3%FC%AC%A9%3F%B3%D9.%D7%25%A7%0C%F5%D9YWL5%CA5%2B%0B%B5%D1%AC%20%BD%F4%D6%D1b%0D%AD%D5h%DF%0B7%D1%8E%EC%CD%F7%DF%80%07.%F8%E0%84%17n%F8%E1%88'%AEx(%81%00%00%3B",
GPI_PIXEL: "data:image/gif,GIF89a%01%00%01%00%80%00%00%FF%FF%FF%00%00%00!%F9%04%01%00%00%00%00%2C%00%00%00%00%01%00%01%00%00%02%02D%01%00%3B",
TIMEZONE_OFFSET: new Date().getTimezoneOffset(),

GP_setDocument: function(currentDoc) {
  this.GP_DOCUMENT = currentDoc;
},

getDocument: function() {
  return this.GP_DOCUMENT;
},

getRealGoogleUrl: function(href) {
    var realUrl2 = href.match(/https?:\/\/(?:www\.)?google\.[^\/]+\/url\?.*url=(https?:.+)$/i);
    if (realUrl2) {
    	var maybeUrl = realUrl2[1];
    	var iamp = maybeUrl.indexOf("&");
    	if (iamp > 0) {
    		maybeUrl = maybeUrl.substring(0, iamp);
    	}            				
    	return unescape(maybeUrl);	
    }

    var realUrl = href.match(/https?:\/\/(?:www\.)?google\.[^\/]+\/url\?.*q=(https?:.+)$/i);
    if (realUrl) {
    	var maybeUrl = realUrl[1];
    	var iamp = maybeUrl.indexOf("&");
    	if (iamp > 0) {
    		maybeUrl = maybeUrl.substring(0, iamp);
    	}            				
    	return unescape(maybeUrl);	
    }
    return href;
},

getRealGoogleUrlAjax: function(href) {
    var realUrl = href.match(/https?:\/\/(?:www\.)?google\.[^\/]+\/url\?.*url=(https?:.+)$/i);
    if (realUrl) {
    	var maybeUrl = realUrl[1];
    	var iamp = maybeUrl.indexOf("&");
    	if (iamp > 0) {
    		maybeUrl = maybeUrl.substring(0, iamp);
    	}            				
    	return unescape(maybeUrl);	
    }
    return href;
},

GP_addStyle: function(styleString) {
	var styleElement = this.getDocument().createElement("style");
	styleElement.type = "text/css";
	styleElement.appendChild(this.getDocument().createTextNode(styleString));
	this.getDocument().getElementsByTagName("head")[0].appendChild(styleElement);		
},

getGPSub: function(href) {
	if (this.GP_BEST_IMAGE_SERVER && this.GP_BEST_IMAGE_SERVER.length > 0) {
		return this.GP_BEST_IMAGE_SERVER;
	}
	var d = new Date();
    var soff = Math.max(new Date(d.getFullYear(), 0, 1).getTimezoneOffset(), new Date(d.getFullYear(), 6, 1).getTimezoneOffset());
    if (soff >= 420) {
    	this.GP_BEST_IMAGE_SERVER = "sfo"; 
    }
    else if (soff >= 180) {
    	this.GP_BEST_IMAGE_SERVER = "nyc";
    }
    else if (soff <= -420) {
    	this.GP_BEST_IMAGE_SERVER = "jp";
    }
    else {
    	this.GP_BEST_IMAGE_SERVER = (Math.random() >= 0.5) ? "eu1" : "eu2";
    }
    console.log("SP: Best image server: " + this.GP_BEST_IMAGE_SERVER  +"\n");
    return this.GP_BEST_IMAGE_SERVER;
},

isSSL: function(_doc) {
	return _doc.location && _doc.location.toString().indexOf("https") == 0;
},

getImageURL: function(href) {
    //bad soft warning
    var mw = href.match(/https?:\/\/www\.google\..*\/interstitial\?url=/i);
    if (mw) {
        return this.GPI_PREVIEW_WARN;
    }
    var fullDomain = this.getFullDomain(href);
    var protocol = "unknown";
    var site = fullDomain;
    if (site.indexOf("http://") == 0) {
        site = site.substring(7, site.length);
        protocol = "http://";
    } 
    else if (site.indexOf("https://") == 0) {
        site = site.substring(8, site.length);
        protocol = "https://";
    }
    var spProt = this.isSSL(this.getDocument()) ? "https://" : "http://";
    var idnasite = site; //TODO: this.IDNA_SERVICE.convertUTF8toACE(site);
    var preview = spProt+this.getGPSub(idnasite)+".searchpreview.de/preview?s=" + protocol + idnasite + "&ua=gc&ver="+this.GP_VERSION;
	return preview;
},

getFullDomain: function(href) {
    var domain = href.match(/http(?:s)?:\/\/[^\/]+/i);
    return domain ? domain[0].toLowerCase() : href;
},

getRealURL: function(href)
{
    return href;
},

createThumbnail: function(href, a) {
	href = this.getRealURL(href);
    thumb = this.getDocument().createElement("img");
    thumb.setAttribute("align", "left");	
	thumb.setAttribute("src", this.getImageURL(href));
    thumb.style.width = "111px";
    thumb.style.height = "82px";
    thumb.style.backgroundPosition = "center";
	thumb.style.backgroundRepeat = "no-repeat";
	thumb.style.border = "1px solid #BBBBBB";
	thumb.style.margin = "2px 4px 5px 0px";
    return thumb;
},

createProductPreview: function(href, imageSource) {
    thumb = this.getDocument().createElement("img");
    thumb.setAttribute("align", "left");	
	thumb.setAttribute("src", imageSource);
    //thumb.style.backgroundPosition = "center";
	//thumb.style.backgroundRepeat = "no-repeat";
	thumb.style.border = "0px solid #BBBBBB";
	thumb.style.margin = "0px 10px 0px 7px";
    return thumb;
},

createThumbLink: function(thumb, a) {
	var linka = this.getDocument().createElement("a");
	linka.href = a.href;
	linka.insertBefore(thumb, linka.firstChild);	
	return linka;
},

clearAndPadTop: function(xpath, padLIParent, ignoreStyle) {
    var notModifiedGs = this.getDocument().evaluate(xpath, this.getDocument(), null, XPathResult.ANY_TYPE, null);
    var g = notModifiedGs.iterateNext();
    var gs = new Array();
    while (g) {
        gs.push(g);
        g = notModifiedGs.iterateNext();
    }
    for(var gi=0; gi<gs.length; gi++) {
        if (gs[gi].getAttribute("style") == null || ignoreStyle) {
            gs[gi].style.clear = "left";
            gs[gi].style.paddingTop = "10px";    	
            
            if (padLIParent) {
            	var li = gs[gi].parentNode;
            	if (li.tagName == "LI") {
            		li.style.clear = "left";
            		li.style.paddingTop = "10px";
            	}
            }	
        }
    }	
},

thumbshots: function(url) {
	var head = this.getDocument().getElementsByTagName("head")[0];
	if (head.getAttribute("done") == "done")
		return;

	var t = 0;	
	if (this.isGoogle(""+url)) {
		var lis = this.getDocument().getElementsByTagName("li");
		for (var i=0; i<lis.length; i++) {
			var result;
			if (t < this.MAX_IMAGES_PER_PAGE) {
				result = this.processGoogleLiTag(lis[i], this.getDocument(), t);
			}	
			if (result && result.previewInserted) {		
				t++;	
			}
		}
	}
	
	if (t > 0) {
	   	head.setAttribute("done", "done");	
    }
},

reloadLocation: function() {
	this.getDocument().location.reload();
},

isGoogle: function(href) {
	return href.match(/https?:\/\/(www|ipv6|encrypted)(|[0-9])\.(|l\.)google\..*\/search\?.*/i);
},

isGoogleCom: function(href) {
	return href.match(/https?:\/\/(www|ipv6|encrypted)(|[0-9])\.(|l\.)google\.com.*\/search\?.*/i);
},

isGoogleDe: function(href) {
	return href.match(/https?:\/\/(www|ipv6|encrypted)(|[0-9])\.(|l\.)google\.de.*\/search\?.*/i);
},

isEngine: function(href) {
    return this.isGoogle(href) || this.isYahoo(href) || this.isSDKSearch(href); 
},

getGoogleQ: function() {
	return this.getDocument().getElementsByName("q")[0];
},

forceReload:function(img) {
	var l = img.getAttribute("src");
	img.setAttribute("src", com.googlepreview.package.GPI_PIXEL);
	img.setAttribute("src", l);	
},

fetchElement:function(doc, filter, start) {
	var elems = doc.evaluate(filter, start, null, XPathResult.ANY_TYPE, null);
	var elem = elems.iterateNext();
	return elem;
},
getQParam: function(url) {
	var q = url.match(/.*(\&|\?)q=(.*?)\&/)[2];
	q = decodeURIComponent(q);
	q = q.replace(/\+/g," ");
	return q;
},
isSSL: function(_doc) {
	return _doc.location && _doc.location.toString().indexOf("https") == 0;
},
escapeForSafeHtml: function(s) {
	if (s == null)
		return null;
	s = s.replace(/</g, "&lt;");
	s = s.replace(/"/g, "&quot;");
	s = s.replace(/'/g, "&apos;");
	return s.replace(/>/g, "&gt;");
},
getNodeValue: function(node, name) {
    var elems = node.getElementsByTagName(name);
    if (!elems) {
        return "";
    }
    var elem = elems[0];
    var value = (elem && elem.childNodes[0]) ? elem.childNodes[0].nodeValue : "";
    value = this.escapeForSafeHtml(value);
    return value;
},
shorten: function(s, max) {
	if (s && s.length > max) {
		return s.substring(0, max-1) + "...";
	}
	return s;
},
GP_highlight: function(text, q, _package) {
	var words = q.split(/\W+/);
	if (!words || words.length == 0) {
		return text;
	}
	
	for(var i=0; i < words.length; i++) {
		var w = words[i];
		if (w != null && w.length >= 3 && w != "<b>" && w != "</b>" && w.indexOf("<") == -1 && w.indexOf(">") == -1) {
			text = text.replace(new RegExp("(\\b"+w+"(\\w+)?)", "gi"), function(a,b) {
				return "<b>"+b+"</b>";
			});	
		}	
	}
	
	return text;
},
makeBold: function(a,b) {
	return "<b>"+b+"</b>";
},
getAdLI: function(title, text, displayUrl, clickUrl, citeUrl, nMore, imageUrl, trackUrl, _doc) {
	var li = _doc.createElement("li");
	//console.log(li.style);
	li.className = "foo g";
	li.style.clear = "left";
	//li.style.paddingBottom = "12px";
	li.style.maxWidth = "47em";
	li.style.backgroundColor = "#fffae7";
	li.style.minHeight = "103px";
	
	var a = _doc.createElement("a");
	a.href = clickUrl;       
	a.appendChild(this.createThumbnail(displayUrl, a));
    
    var h3 = _doc.createElement("h3");
    h3.className = "r";
    //always inline
    h3.style.display = "inline";
    h3.style.whiteSpace = "normal";
    
    var h3a = _doc.createElement("a");
    h3a.className = "l";
    h3a.innerHTML = title;
    h3a.href = clickUrl;
    
    var div = _doc.createElement("div");
    div.className = "s";
    var marker = chrome.i18n.getMessage("ex_ads");
    
    var tu = (trackUrl && trackUrl.length > 0) ? "<img width='1' height='1' border='0' src='"+trackUrl+"' />" : "";    
    div.innerHTML = text + "<br/>" + "<cite>" + citeUrl + "</cite>" + tu;
    
    var markerDiv = _doc.createElement("div");
    markerDiv.innerHTML = marker;
    markerDiv.setAttribute("class", "f");
    markerDiv.style.fontSize = "small";
    markerDiv.style.textAlign = "right";
    
    h3.appendChild(h3a);
    
    li.appendChild(markerDiv);
    li.appendChild(a);
    li.appendChild(h3);
    li.appendChild(div);	
    
    if (nMore > 0) {
    	var lDiv = _doc.createElement("div");
    	var aLink = _doc.createElement("span");
    	aLink.style.color = "#7777CC";
    	aLink.style.cursor = "pointer";
    	aLink.style.textDecoration = "underline";
    	aLink.setAttribute("onclick","document.getElementById('__gp__more__ads__').style.display = 'block';");
    	if (nMore == 1) 
    		aLink.innerHTML = "Show " + nMore + " more &#187;";
    	else 
    		aLink.innerHTML = "Show " + nMore + " more &#187;";
    		
    	lDiv.appendChild(aLink);
    	li.appendChild(lDiv);
    }    
    li.setAttribute("id", "-_-gpad-_-");
    return li;
},
adFeedRender: function(xml, responseInMs, qParam) {
	var doc = this.getDocument();
	var existing = doc.getElementById("-_-gpad-_-");
	
	if (existing) {
		existing.parentNode.removeChild(existing);
	}
	var RENDER_TOP_MAX_MS = 1300;
	
	var parser = new DOMParser();
	var xmldoc = parser.parseFromString(xml,"text/xml"); 
	var adPos = 0;
	var adsTag = xmldoc.getElementsByTagName("ads");
	if (!adsTag || adsTag.length != 1) {
		return;
	}
	var posAtt = adsTag[0].getAttribute("pos");
	if (posAtt) {
		var tempPos = parseInt(posAtt);
		if (tempPos >= 0 && tempPos < 9) {
			adPos = tempPos;
		}
	}
	var ssl = this.isSSL(doc);
	var ads = xmldoc.getElementsByTagName("ad");

	if (ads && ads.length > 0) {	
		var ols = doc.evaluate("//ol[@id='rso']", doc, null, XPathResult.ANY_TYPE, null);		
        var olToAddTo = ols.iterateNext();
		if (!olToAddTo) {
			ols = doc.evaluate("//div[@id='res']/span/div/ol", doc, null, XPathResult.ANY_TYPE, null);
			olToAddTo = ols.iterateNext();
		}
		if (!olToAddTo) {
			ols = doc.evaluate("//div[@id='res']/div/div/ol", doc, null, XPathResult.ANY_TYPE, null);
			olToAddTo = ols.iterateNext();
		}
		if (!olToAddTo) {
			ols = doc.evaluate("//div[@id='res']/div/ol", doc, null, XPathResult.ANY_TYPE, null);
			olToAddTo = ols.iterateNext();
		}

        var restContainer;        
        var maxAds = Math.min(ads.length, 6);
        
		for (var i = 0; i < maxAds; i++) {
			var clickUrl = this.getNodeValue(ads[i], "clickUrl");
			var title = this.getNodeValue(ads[i], "title");
			var displayUrl = this.getNodeValue(ads[i], "displayUrl");
			var text = this.getNodeValue(ads[i], "text");			
			var imageUrl = this.getNodeValue(ads[i], "imageUrl");
			var trackUrl = this.getNodeValue(ads[i], "trackUrl");
			
			if (ssl) {
				if (imageUrl && imageUrl.indexOf("https") != 0) {
					imageUrl = "";
				}
				if (trackUrl && trackUrl.indexOf("https") != 0) {
					trackUrl = "";
				}
			}
			
			text = this.shorten(text, 150);
			title = this.shorten(title, 70);
			displayUrl = this.shorten(displayUrl, 100);
			
			title = this.GP_highlight(title, qParam, doc);
			text = this.GP_highlight(text, qParam, doc);

			displayUrl = displayUrl.toLowerCase();
			if (displayUrl.indexOf("http://") == -1) {
				displayUrl = "http://" + displayUrl;
			}
			
			var citeUrl = displayUrl.indexOf("http://") == 0 ? displayUrl.substring(7,displayUrl.length) : displayUrl;					
			if (citeUrl.indexOf("/") == -1) {
				citeUrl += "/";
			}
			
			var adAddedBefore;
			
			if (i == 0) {
				var li = this.getAdLI(title, text, displayUrl, clickUrl, citeUrl, maxAds - 1, imageUrl, trackUrl, doc);   
				if (responseInMs > RENDER_TOP_MAX_MS) {       
	           		olToAddTo.appendChild(li);
	            }
	            else {
					if (adPos == 0) {
						var taw = doc.getElementById("center_col");
						if (taw) {
							var newOl = doc.createElement("ol");
							taw.insertBefore(newOl, taw.firstChild);
							olToAddTo = newOl;
						}
						olToAddTo.insertBefore(li, olToAddTo.firstChild);
					}
					else {
						//find adPos'th li
						var children = olToAddTo.childNodes;
						var liNum = 0;
						for (var ci = 0; ci < children.length; ci++) {
							if (children[ci].nodeName == "LI") {
								liNum++;
								if (liNum == adPos) {
									adAddedBefore = children[ci];
									olToAddTo.insertBefore(li, adAddedBefore);
									break;
								}
							}
						}
						
					}
	            }
            }

            if (i == 1) {
            	var div = doc.createElement("div");
            	div.style.paddingLeft = "77px";
            	div.style.display = "none";
            	div.setAttribute("id", "__gp__more__ads__");
            	var liForDiv = doc.createElement("li");//li
            	liForDiv.appendChild(div);
            	restContainer = doc.createElement("ul");//ol
            	div.appendChild(restContainer);
            	if (responseInMs > RENDER_TOP_MAX_MS) {
            		olToAddTo.appendChild(liForDiv);
            	}
            	else {
					if (adPos == 0) {
						olToAddTo.insertBefore(liForDiv, olToAddTo.firstChild.nextSibling);	
					}
					else {
						olToAddTo.insertBefore(liForDiv, adAddedBefore);	
					}
            	}
            }
            
            if (i >= 1) {            	
            	var li = this.getAdLI(title, text, displayUrl, clickUrl, citeUrl, 0, imageUrl, trackUrl, doc);            
            	restContainer.appendChild(li);
            }
    	}
	}	
},
processGoogleLiTag:function(li, doc, t) {
	if (li == null || !li.getAttribute || (li.getAttribute("id") && li.getAttribute("id").indexOf("box") >= 0) || li.getAttribute("class") == null || (li.getAttribute("class").charAt(0) != 'g' && li.getAttribute("class") != "tl")) return false;
	//Fixed: +1ed sites did not get a preview
	if (doc.evaluate(".//table[@class='ts']//img[@width!=24 and @height!=24]", li, null, XPathResult.ANY_TYPE, null).iterateNext() != null) return false;
	if (doc.evaluate(".//div[contains(@class, 'thb')]", li, null, XPathResult.ANY_TYPE, null).iterateNext() != null) return false;
	
	//table class="ts" but with no image
	var tableTS = doc.evaluate(".//table[@class='ts']", li, null, XPathResult.ANY_TYPE, null).iterateNext()
	if (tableTS != null) {
		//may not be first sub node of li
		if (doc.evaluate("./table[@class='ts']", li, null, XPathResult.ANY_TYPE, null).iterateNext() != null) {
			return false;
		}
		tableTS.style.clear = "none";
	}
	
	li.style.clear = "left";
	var h3 = com.googlepreview.package.fetchElement(doc, ".//h3[@class='r']", li);
	if (h3 == null) return false;
	var h3Parent = h3.parentNode;
	if (!(h3Parent.getAttribute("class") == "vsc" ||Â h3Parent.getAttribute("class") == "rc")) return false;

	var s = com.googlepreview.package.fetchElement(doc, ".//div[@class='s']", li);

	//Google experimental "hover to init Google's own result previews"
	h3.style.display = "inline";
	
	var a = h3.firstChild;
	if (a == null) return false;
	
	if (!(a instanceof HTMLAnchorElement) /*|| a.getAttribute("class") == null || a.getAttribute("class").indexOf("l") != 0*/) return false;
	var isNoJSVersion = (a.getAttribute("class") == null || a.getAttribute("class").indexOf("l") != 0) ? true : false; 
	var href = a.href;
	href = isNoJSVersion ? com.googlepreview.package.getRealGoogleUrl(href) : com.googlepreview.package.getRealGoogleUrlAjax(href);
	var result = new Object();
	result.a = a;
	if (href.indexOf("http://") == 0 || href.indexOf("https://") == 0) {					
		if ("done" != a.getAttribute("done") && a.text != null && a.text.length > 0) {
			result.previewInserted = true;				
			var thumb;					
            thumb = com.googlepreview.package.getDocument().createElement("img");
            thumb.setAttribute("align", "left");	
            thumb.setAttribute("src", com.googlepreview.package.GPI_PIXEL);
            thumb.style.width = "111px";
            thumb.style.height = "82px";
			thumb.setAttribute("width", "111");
			thumb.setAttribute("height", "82");
            thumb.style.backgroundPosition = "center";
            thumb.style.backgroundRepeat = "no-repeat";
            thumb.style.border = "1px solid #BBBBBB";
            thumb.style.margin = "4px 4px 5px 0px";
			
			var linka = com.googlepreview.package.createThumbLink(thumb, a);

			thumb.setAttribute("src", com.googlepreview.package.getImageURL(href, doc));
			a.setAttribute("done", "done");
			
			//new table style
			var table = doc.createElement("table");
			table.setAttribute("class", "ts");
			table.style.width = "100%";
			
			var tbody = doc.createElement("tbody");
			table.appendChild(tbody);
			
			var tr1 = doc.createElement("tr");
			tbody.appendChild(tr1);
			
			var td1 = doc.createElement("td");
			td1.setAttribute("colspan", "2");
			tr1.appendChild(td1);
			td1.appendChild(h3Parent.removeChild(h3));
					
			var tr2 = doc.createElement("tr");
			tbody.appendChild(tr2);
			
			var td2 = doc.createElement("td");
			td2.setAttribute("valign", "top");
			td2.setAttribute("width", "1");
			tr2.appendChild(td2);
			td2.appendChild(linka);
			
			var td3 = doc.createElement("td");
			td3.setAttribute("valign", "top");
			tr2.appendChild(td3);
			
			var VSCChildrenToMove = new Array();
			var VSCChildNodes = h3Parent.childNodes;
			for(var i=0; i<VSCChildNodes.length; i++) {
				if (!VSCChildNodes[i].getAttribute || VSCChildNodes[i].getAttribute("class") != "vspib") {
					VSCChildrenToMove.push(VSCChildNodes[i]);
				}
			}
			
    		for(var ci=0; ci<VSCChildrenToMove.length; ci++) {
    			td3.appendChild(h3Parent.removeChild(VSCChildrenToMove[ci]));
    		}

			h3Parent.appendChild(table);
			if (t==0) {
				doc.getElementById("center_col").style.width = "550px";
			}
		}
	}
    return result;
}
}

var u = document.location.toString();
if (!u.match(/https?:\/\/(www|ipv6|encrypted)(|[0-9])\.(|l\.)google\..*\/.*/i)) {
	;
}
else {
	com.googlepreview.package.GP_setDocument(document);
	com.googlepreview.package.thumbshots(document.location);
	com.googlepreview.package.GP_addStyle(".st {word-wrap: break-word;}", document);
	
	var realQ2 = com.googlepreview.package.getGoogleQ(document).value;

	chrome.runtime.sendMessage({command: "spads", qgi: realQ2, location: document.location.href}, function(response) {
		//console.log("__response:" + response + "\n");
		if (response.xml && response.xml.length > 10) {
			com.googlepreview.package.adFeedRender(response.xml, response.rms, realQ2);
		}
	});
	
	if (typeof WebKitMutationObserver == "function") {
		console.log("SP: MutationSummary\n");
		new MutationSummary({ callback: handleMutations, queries: [{ element: "*" }] });  
	}
	else {
		console.log("SP: DOMNodeInserted\n");
		document.addEventListener("DOMNodeInserted", handleInsertedNode);
	}
	
	chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
	    if (request.method == "updatePreview") {	
	    	var i = request.sourceUrl.indexOf("s=http");
	    	if (i > 0) {
	    		var proto = request.sourceUrl.indexOf("https") == 0 ? "https" : "http";
	    		var updateUrl = proto + "://a.searchpreview.de/update?" + request.sourceUrl.substring(i) + "&retpic=true";
	    		var affected = document.evaluate("//img[@src='"+request.sourceUrl+"']", document, null, XPathResult.ANY_TYPE, null);
	    		var runner = affected.iterateNext();
	    		var changeArray = new Array();
	    		
	    		while (runner != null ) {
	    			changeArray.push(runner);
	    			runner = affected.iterateNext();
	    		}
	    		
	    		for(var ci=0; ci<changeArray.length; ci++) {	
	    			var url = ci == 0 ? updateUrl : (proto + "://a.searchpreview.de/up-req.gif");
	    			changeArray[ci].setAttribute("src", url);	    			
	    			changeArray[ci].style.backgroundImage = "url("+request.sourceUrl+")";
	    		}
	    	}
	    }
	});
}

function handleMutations(summaries) { 	
	var elementSummary = summaries[0]; 
	for (var i = 0; i < elementSummary.added.length; i++) {
		var e = elementSummary.added[i];
		//console.log("handleMutations: "+e+": " + e.innerHTML + "\n");
		handleInsertedNodeMutation(e);
	}
}
	
var t=0;
var realQ = "";
function handleInsertedNodeMutation(node) {	
	if (node instanceof HTMLDivElement && "navcnt" == node.getAttribute("id")) {		
		if (t > 0) {
			//console.log("---"+document.getElementById("rhs_block")+"\n")
			
			t=0;
			imagesLink = document.getElementById("gb_2");
			if (imagesLink == null) {
				imagesLink = document.getElementById("pnnext");
			}
			if (imagesLink != null) {
				imagesHref = imagesLink.href;
				realQ = com.googlepreview.package.getQParam(imagesHref);
				var _p = com.googlepreview.package;
				if (true) {
					chrome.runtime.sendMessage({command: "spads", qgi: realQ, location: document.location.href}, function(response) {
						if (response.xml && response.xml.length > 10) {
							_p.adFeedRender(response.xml, response.rms, realQ);
						}
					});

				}
			}
		}
		t=0;
	}
	
	if (node instanceof HTMLLIElement) {
		var result;
		//preview
		var li = node;
		if (t < com.googlepreview.package.MAX_IMAGES_PER_PAGE) {		
			result = com.googlepreview.package.processGoogleLiTag(li, document, t);		
			if (result && result.previewInserted) {
				t++;
			}
		}
	}	
}

function handleInsertedNode(evt) {	
	if ( (evt.relatedNode instanceof HTMLDivElement && "xfoot" == evt.relatedNode.getAttribute("id"))
			|| evt.relatedNode instanceof HTMLTableRowElement || evt.relatedNode instanceof HTMLBodyElement 
			|| evt.relatedNode instanceof HTMLParagraphElement) {
		if (t > 0) {	
			imagesLink = document.getElementById("gb_2");
			imagesHref = imagesLink.href;
			realQ = com.googlepreview.package.getQParam(imagesHref);
		}
	
		if (t > 0) {
			var _p = com.googlepreview.package;
			if (true) {
				chrome.extension.sendRequest({command: "spads", qgi: realQ, location: document.location.href}, function(response) {
					if (response.xml && response.xml.length > 10) {
						_p.adFeedRender(response.xml, response.rms, realQ);
					}
				});
			}					
		}
		t=0;
	}
	
	if (evt.relatedNode instanceof HTMLOListElement) {
		var result;
		//preview
		var li = evt.target;
		if (t < com.googlepreview.package.MAX_IMAGES_PER_PAGE) {		
			result = com.googlepreview.package.processGoogleLiTag(li, document, t);		
			if (result && result.previewInserted) {
				t++;
			}
		}
	}	
}


